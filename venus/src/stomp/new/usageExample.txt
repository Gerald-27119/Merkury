// src/components/ChatRoom.tsx
import React, { useState } from "react";
import { useWebSocket, SubscriptionDef } from "../hooks/useWebSocket";
import { ChatMessageDto } from "../model/chat";

/**
 * Przykład czatu:
 * - subskrybujemy topic wiadomości
 * - renderujemy listę
 * - wysyłamy wiadomości
 */
export const ChatRoom: React.FC<{ chatId: number }> = ({ chatId }) => {
  const [msgs, setMsgs] = useState<ChatMessageDto[]>([]);
  // definicja subskrypcji
  const subs: SubscriptionDef[] = [
    {
      destination: `/topic/messages/${chatId}`,
      callback: (msg) => {
        const chat = JSON.parse(msg.body) as ChatMessageDto;
        setMsgs(prev => [...prev, chat]);
      }
    }
  ];

  // używamy hooka: zero useEffectów w komponencie
  const { publish, connected } = useWebSocket({ subscriptions: subs });

  const send = () => {
    if (!connected) return alert("Łączę się, spróbuj za chwilę");
    publish("/app/chat.send", { chatId, content: "Hej wszystkim!" });
  };

  return (
    <div>
      <button onClick={send} disabled={!connected}>
        {connected ? "Wyślij" : "Łączenie..."}
      </button>
      <ul>
        {msgs.map((m,i) => (
          <li key={i}>{m.sender.name}: {m.content}</li>
        ))}
      </ul>
    </div>
  );
};
